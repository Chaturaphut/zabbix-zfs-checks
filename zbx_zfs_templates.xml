<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>2.0</version>
    <date>2016-07-14T19:39:03Z</date>
    <groups>
        <group>
            <name>Templates</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Template ZFS</template>
            <name>Template ZFS</name>
            <description>Template relativo al controllo dei pool zfs, richiede custom parameter presenti nelle configurazioni dell'agent, uno script per il discovery in formato JSON, i permessi di suoders per l'utility zpool.&#13;
&#13;
CUSTOM PARAMETERS:&#13;
/etc/zabbix/zabbix_agentd.d/userparameter_zfs.conf :&#13;
UserParameter=zpool.discover,/bin/discover-zfspool.sh&#13;
UserParameter=zpool.health[*],sudo zpool list -H -o health $1&#13;
&#13;
SCRIPT /bin/discover-zfspool.sh:&#13;
#!/bin/bash&#13;
declare -a pools&#13;
#pools=(a b c)&#13;
&#13;
n=0&#13;
#for i in $(/sbin/zpool list -H -o name) ; do&#13;
for i in $(sudo zpool list -H -o name); do&#13;
  pools[$n]=&quot;$i&quot;&#13;
  #echo &quot;Pool: $n = $i&quot;     #to confirm the entry&#13;
  let &quot;n= $n + 1&quot;&#13;
done&#13;
# Get length of an array&#13;
length=${#pools[@]}&#13;
let &quot;last= $length - 1&quot;&#13;
&#13;
for (( i=0; i&lt;${length}; i++ ))&#13;
do&#13;
        if [ $i == $last ]; then&#13;
            POOL=&quot;{\&quot;{#ZFSPOOL}\&quot;:\&quot;${pools[$i]}\&quot;}&quot;&#13;
        else&#13;
            POOL=&quot;{\&quot;{#ZFSPOOL}\&quot;:\&quot;${pools[$i]}\&quot;},&quot;&#13;
        fi&#13;
    POOLALL=&quot;$POOLALL&quot;&quot;$POOL&quot;&#13;
done&#13;
&#13;
echo &quot;{\&quot;data\&quot;:[&quot;$POOLALL&quot;]}&quot;&#13;
&#13;
&#13;
SUDOERS /etc/sudoers.d/zabbix :&#13;
# Zabbix permission&#13;
    &#13;
Defaults:zabbix !requiretty   &#13;
zabbix ALL=NOPASSWD: /sbin/zpool</description>
            <groups>
                <group>
                    <name>Templates</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>ZFS Checks</name>
                </application>
            </applications>
            <items/>
            <discovery_rules>
                <discovery_rule>
                    <name>Zpool Discovery</name>
                    <type>0</type>
                    <snmp_community/>
                    <snmp_oid/>
                    <key>zpool.discover</key>
                    <delay>3600</delay>
                    <status>0</status>
                    <allowed_hosts/>
                    <snmpv3_contextname/>
                    <snmpv3_securityname/>
                    <snmpv3_securitylevel>0</snmpv3_securitylevel>
                    <snmpv3_authprotocol>0</snmpv3_authprotocol>
                    <snmpv3_authpassphrase/>
                    <snmpv3_privprotocol>0</snmpv3_privprotocol>
                    <snmpv3_privpassphrase/>
                    <delay_flex/>
                    <params/>
                    <ipmi_sensor/>
                    <authtype>0</authtype>
                    <username/>
                    <password/>
                    <publickey/>
                    <privatekey/>
                    <port/>
                    <filter>
                        <evaltype>0</evaltype>
                        <formula/>
                        <conditions>
                            <condition>
                                <macro>{#ZFSPOOL}</macro>
                                <value>@Linux ZFS Zpool</value>
                                <operator>8</operator>
                                <formulaid>A</formulaid>
                            </condition>
                        </conditions>
                    </filter>
                    <lifetime>14</lifetime>
                    <description/>
                    <item_prototypes>
                        <item_prototype>
                            <name>Zpool Status {#ZFSPOOL}</name>
                            <type>0</type>
                            <snmp_community/>
                            <multiplier>0</multiplier>
                            <snmp_oid/>
                            <key>zpool.health[{#ZFSPOOL}]</key>
                            <delay>120</delay>
                            <history>31</history>
                            <trends>365</trends>
                            <status>0</status>
                            <value_type>1</value_type>
                            <allowed_hosts/>
                            <units/>
                            <delta>0</delta>
                            <snmpv3_contextname/>
                            <snmpv3_securityname/>
                            <snmpv3_securitylevel>0</snmpv3_securitylevel>
                            <snmpv3_authprotocol>0</snmpv3_authprotocol>
                            <snmpv3_authpassphrase/>
                            <snmpv3_privprotocol>0</snmpv3_privprotocol>
                            <snmpv3_privpassphrase/>
                            <formula>1</formula>
                            <delay_flex/>
                            <params/>
                            <ipmi_sensor/>
                            <data_type>0</data_type>
                            <authtype>0</authtype>
                            <username/>
                            <password/>
                            <publickey/>
                            <privatekey/>
                            <port/>
                            <description>zpool status returned or error to list always stored like a char</description>
                            <inventory_link>0</inventory_link>
                            <applications>
                                <application>
                                    <name>ZFS Checks</name>
                                </application>
                            </applications>
                            <valuemap/>
                            <logtimefmt/>
                        </item_prototype>
                    </item_prototypes>
                    <trigger_prototypes>
                        <trigger_prototype>
                            <expression>{Template ZFS:zpool.health[{#ZFSPOOL}].str(ONLINE)}=0</expression>
                            <name>Zpool Error [{#ZFSPOOL}]</name>
                            <url/>
                            <status>0</status>
                            <priority>3</priority>
                            <description/>
                            <type>0</type>
                        </trigger_prototype>
                    </trigger_prototypes>
                    <graph_prototypes/>
                    <host_prototypes/>
                </discovery_rule>
            </discovery_rules>
            <macros/>
            <templates/>
            <screens/>
        </template>
    </templates>
</zabbix_export>
